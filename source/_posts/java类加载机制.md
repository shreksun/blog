---
title: java类加载机制
date: 2019-03-05 19:11:12
categories:
- Java
tags:
- JVM
---

- 将.class文件二进制读入内存，在堆区创建Class对象，在方法区存储类的数据结构。

<!--more-->

#### 加载

- 通过一个类的全限定名来获取其定义的二进制字节流。
- 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。
- 在Java堆中生成一个代表这个类的 java.lang.Class对象，作为对方法区中这些数据的访问入口。

#### 连接

- 验证：确保被加载的类的正确性

- 准备： 为静态变量分配默认值（仅包括类变量（**static**），而不包括实例变量）
  ConstantValue 会在编译期赋值

- 解析：把类中的符号引用转换为直接引用，常量池内的符号引用替换为直接引用的过程

- 初始化：为类的静态变量赋予正确的初始值
  ①声明类变量是指定初始值
  ②使用静态代码块为类变量指定初始值
  步骤：
  1、假如这个类还没有被加载和连接，则程序先加载并连接该类

  2、假如该类的直接父类还没有被初始化，则先初始化其**直接父类**

  3、假如类中有初始化语句，则系统依次执行这些初始化语句

- **类初始化时机**：只有当对类的主动使用的时候才会导致类的初始化

1. 创建类的实例，也就是new的方式
2. 访问某个类或接口的静态变量，或者对该静态变量赋值
3. 调用类的静态方法
4. 反射（如Class.forName(“com.shengsiyuan.Test”)）
5. 初始化某个类的子类，则其父类也会被初始化
6. Java虚拟机启动时被标明为启动类的类（ JavaTest），直接使用 java.exe命令来运行某个主类

- 结束生命周期

1. 执行了 System.exit()方法
2. 程序正常执行结束
3. 程序在执行过程中遇到了异常或错误而异常终止
4. 由于操作系统出现错误而导致Java虚拟机进程终止

#### 类加载器

- 启动类加载器：负责加载存放在 JDK\jre\lib 启动类加载器是无法被Java程序直接引用的。
- 扩展类加载器：负责加载 JDK\jre\lib\ext目录中，开发者可以直接使用扩展类加载器。
- 应用程序类加载器：它负责加载用户类路径（ClassPath）所指定的类，开发者可以直接使用该类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。

#### 双亲委派模型

加载时，依次向上，只有父加载器无法加载时，子加载器才会加载
双亲委派模型意义：

- 系统类防止内存中出现多份同样的字节码
- 保证Java程序安全稳定运行

源引：[关于Jvm知识看这一篇就够了](https://zhuanlan.zhihu.com/p/34426768)